<div class="card">
  <div class="card-header">
    <div class="row">
      <div class="col-md-6">
        <h5 class="card-title">
          <i class="fas fa-tasks me-2"></i>
          {{ '::Menu:Tasks' | abpLocalization }}
        </h5>
      </div>
      <div class="col-md-6 text-end">
        <button
          class="btn btn-primary"
          type="button"
          (click)="createTask()"
          *abpPermission="'TaskManagement.Tasks.Create'"
        >
          <i class="fa fa-plus me-1"></i>
          <span>{{ '::NewTask' | abpLocalization }}</span>
        </button>
      </div>
    </div>
  </div>

  <div class="card-body">
    <div class="row mb-3">
      <div class="col-md-3">
        <label class="form-label">{{ '::Search' | abpLocalization }}</label>
        <nz-input-group [nzSuffix]="suffixIconSearch">
          <input
            type="text"
            nz-input
            [placeholder]="'::SearchPlaceholder' | abpLocalization"
            [(ngModel)]="filterText"
            (keyup.enter)="onSearch()"
          />
        </nz-input-group>
        <ng-template #suffixIconSearch>
          <span nz-icon nzType="search"></span>
        </ng-template>
      </div>

      <div class="col-md-3">
        <label class="form-label">{{ '::Status' | abpLocalization }}</label>
        <nz-select
          [(ngModel)]="filterStatus"
          nzAllowClear
          [nzPlaceHolder]="'::FilterByStatus' | abpLocalization"
          (ngModelChange)="onFilterChange()"
          style="width: 100%"
        >
          <nz-option
            [nzLabel]="'::Enum:TaskStatus.0' | abpLocalization"
            [nzValue]="taskStatus.New"
          ></nz-option>
          <nz-option
            [nzLabel]="'::Enum:TaskStatus.1' | abpLocalization"
            [nzValue]="taskStatus.InProgress"
          ></nz-option>
          <nz-option
            [nzLabel]="'::Enum:TaskStatus.2' | abpLocalization"
            [nzValue]="taskStatus.Completed"
          ></nz-option>
        </nz-select>
      </div>

      <div class="col-md-3">
        <label class="form-label">{{ '::AssignedUser' | abpLocalization }}</label>
        <nz-select
          [(ngModel)]="filterAssignedUserId"
          nzAllowClear
          nzShowSearch
          [nzPlaceHolder]="'::FilterByUser' | abpLocalization"
          (ngModelChange)="onFilterChange()"
          style="width: 100%"
        >
          <nz-option
            *ngFor="let user of users"
            [nzLabel]="user.userName"
            [nzValue]="user.id"
          ></nz-option>
        </nz-select>
      </div>

      <div class="col-md-3">
        <label class="form-label">&nbsp;</label>
        <div>
          <button class="btn btn-outline-secondary w-100" (click)="clearFilters()">
            <i class="fa fa-times me-1"></i>
            {{ '::Clear' | abpLocalization }}
          </button>
        </div>
      </div>
    </div>

    <nz-table
      #tasksTable
      [nzData]="taskData.items"
      [nzTotal]="taskData.totalCount"
      [nzLoading]="loading"
      [nzFrontPagination]="false"
      [nzShowPagination]="true"
      [nzPageSize]="pageSize"
      [nzPageIndex]="pageIndex"
      (nzQueryParams)="onQueryParamsChange($event)"
      [nzShowSizeChanger]="true"
      [nzPageSizeOptions]="[5, 10, 20, 50]"
      nzSize="middle"
    >
      <thead>
        <tr>
          <th nzWidth="30%" nzColumnKey="Title" [nzSortFn]="true">
            {{ '::Title' | abpLocalization }}
          </th>

          <th nzWidth="30%">{{ '::Description' | abpLocalization }}</th>

          <th nzWidth="12%" nzColumnKey="Status" [nzSortFn]="true">
            {{ '::Status' | abpLocalization }}
          </th>

          <th nzWidth="15%">{{ '::AssignedUser' | abpLocalization }}</th>
          <th nzWidth="13%">{{ '::Actions' | abpLocalization }}</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let task of tasksTable.data">
          <td>
            <strong>{{ task.title }}</strong>
          </td>

          <td>
            <span class="text-muted">
              {{ task.description || ('::No Description' | abpLocalization) }}
            </span>
          </td>

          <td>
            <nz-tag [nzColor]="getStatusColor(task.status)">
              {{ getStatusText(task.status) | abpLocalization }}
            </nz-tag>
          </td>

          <td>
            <span *ngIf="task.assignedUserName" class="badge bg-info">
              <i class="fa fa-user me-1"></i>
              {{ task.assignedUserName }}
            </span>
            <span *ngIf="!task.assignedUserName" class="text-muted">
              {{ 'TaskManagement::Unassigned' | abpLocalization }}
            </span>
          </td>

          <td>
            <div class="btn-group btn-group-sm" role="group">
              <ng-container *ngIf="canUpdate(task)">
                <button
                  class="btn btn-outline-primary"
                  (click)="editTask(task)"
                  *abpPermission="'TaskManagement.Tasks.Update'"
                  nz-tooltip
                  [nzTooltipTitle]="'::Edit' | abpLocalization"
                >
                  <i class="fa fa-edit"></i>
                </button>
              </ng-container>

              <ng-container *ngIf="canDelete(task)">
                <button
                  class="btn btn-outline-danger"
                  nz-popconfirm
                  [nzPopconfirmTitle]="'::AreYouSureToDelete' | abpLocalization"
                  (nzOnConfirm)="delete(task.id)"
                  *abpPermission="'TaskManagement.Tasks.Delete'"
                  nz-tooltip
                  [nzTooltipTitle]="'::Delete' | abpLocalization"
                >
                  <i class="fa fa-trash"></i>
                </button>
              </ng-container>
            </div>
          </td>
        </tr>
      </tbody>
    </nz-table>
  </div>
</div>

<nz-modal
  [(nzVisible)]="isModalOpen"
  [nzTitle]="isEditMode ? ('::EditTask' | abpLocalization) : ('::NewTask' | abpLocalization)"
  (nzOnCancel)="handleCancel()"
  [nzFooter]="modalFooter"
  [nzWidth]="600"
>
  <ng-container *nzModalContent>
    <form nz-form [formGroup]="form" nzLayout="vertical">
      <nz-form-item>
        <nz-form-label nzRequired> {{ '::Title' | abpLocalization }} </nz-form-label>
        <nz-form-control [nzErrorTip]="titleErrorTpl">
          <input
            nz-input
            formControlName="title"
            [placeholder]="'::TaskTitlePlaceholder' | abpLocalization"
          />
          <ng-template #titleErrorTpl let-control>
            <ng-container *ngIf="control.hasError('required')">
              {{ '::ThisFieldIsRequired' | abpLocalization }}
            </ng-container>
            <ng-container *ngIf="control.hasError('maxlength')">
              {{ '::MaxLengthExceeded' | abpLocalization: '256' }}
            </ng-container>
          </ng-template>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label> {{ '::Description' | abpLocalization }} </nz-form-label>
        <nz-form-control>
          <textarea
            nz-input
            formControlName="description"
            [placeholder]="'::DescriptionPlaceholder' | abpLocalization"
            [nzAutosize]="{ minRows: 3, maxRows: 6 }"
          ></textarea>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzRequired> {{ '::Status' | abpLocalization }} </nz-form-label>
        <nz-form-control>
          <nz-select formControlName="status" style="width: 100%">
            <nz-option
              [nzLabel]="'::Enum:TaskStatus.0' | abpLocalization"
              [nzValue]="taskStatus.New"
            >
              <nz-tag [nzColor]="'blue'"> {{ '::Enum:TaskStatus.0' | abpLocalization }} </nz-tag>
            </nz-option>
            <nz-option
              [nzLabel]="'::Enum:TaskStatus.1' | abpLocalization"
              [nzValue]="taskStatus.InProgress"
            >
              <nz-tag [nzColor]="'orange'"> {{ '::Enum:TaskStatus.1' | abpLocalization }} </nz-tag>
            </nz-option>
            <nz-option
              [nzLabel]="'::Enum:TaskStatus.2' | abpLocalization"
              [nzValue]="taskStatus.Completed"
            >
              <nz-tag [nzColor]="'green'"> {{ '::Enum:TaskStatus.2' | abpLocalization }} </nz-tag>
            </nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label> {{ '::AssignedUser' | abpLocalization }} </nz-form-label>
        <nz-form-control>
          <nz-select
            formControlName="assignedUserId"
            nzAllowClear
            nzShowSearch
            [nzPlaceHolder]="'::SelectUser' | abpLocalization"
            style="width: 100%"
          >
            <nz-option *ngFor="let user of users" [nzLabel]="user.userName" [nzValue]="user.id">
              <i class="fa fa-user me-2"></i>{{ user.userName }}
            </nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>
    </form>
  </ng-container>

  <ng-template #modalFooter>
    <button nz-button nzType="default" (click)="handleCancel()">
      {{ '::Cancel' | abpLocalization }}
    </button>
    <button nz-button nzType="primary" (click)="save()" [nzLoading]="saving">
      {{ isEditMode ? ('::Update' | abpLocalization) : ('::Create' | abpLocalization) }}
    </button>
  </ng-template>
</nz-modal>
